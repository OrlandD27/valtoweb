{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/PROYECTOS%20FLUTTER/valtoweb/app/api/tipo-cambio/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const period = searchParams.get('period') || '1M'; // 1D, 1W, 1M, 3M, 6M, 1Y\r\n    \r\n    // Intentar obtener datos del BCR (Banco Central de Reserva del Perú) primero\r\n    let currentRate = 3.75; // Valor por defecto\r\n    \r\n    try {\r\n      // API del BCR - Banco Central de Reserva del Perú\r\n      // Endpoint público del BCRP: https://estadisticas.bcrp.gob.pe/estadisticas/series/api/\r\n      // PD04638PD - Serie del tipo de cambio interbancario promedio\r\n      const bcrResponse = await fetch(\r\n        'https://estadisticas.bcrp.gob.pe/estadisticas/series/api/PD04638PD/json',\r\n        {\r\n          headers: {\r\n            'Accept': 'application/json',\r\n          },\r\n          cache: 'no-store'\r\n        }\r\n      );\r\n      \r\n      if (bcrResponse.ok) {\r\n        const bcrData = await bcrResponse.json();\r\n        // El BCR devuelve un array con [fecha, valor]\r\n        if (bcrData && bcrData.periods && bcrData.periods.length > 0) {\r\n          const latestData = bcrData.periods[bcrData.periods.length - 1];\r\n          if (latestData && latestData.values && latestData.values.length > 0) {\r\n            currentRate = parseFloat(latestData.values[0]);\r\n          }\r\n        }\r\n      }\r\n    } catch (bcrError) {\r\n      console.log('BCR API no disponible, usando API alternativa');\r\n      \r\n      // Fallback a exchangerate-api.com\r\n      const response = await fetch(\r\n        `https://api.exchangerate-api.com/v4/latest/USD`,\r\n        {\r\n          headers: {\r\n            'Accept': 'application/json',\r\n          },\r\n          cache: 'no-store'\r\n        }\r\n      );\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        currentRate = data.rates.PEN; // Tipo de cambio USD a PEN\r\n      }\r\n    }\r\n    \r\n    // Generar datos históricos basados en el período\r\n    const endDate = new Date();\r\n    const startDate = new Date();\r\n    \r\n    switch(period) {\r\n      case '1D':\r\n        startDate.setDate(endDate.getDate() - 1);\r\n        break;\r\n      case '1W':\r\n        startDate.setDate(endDate.getDate() - 7);\r\n        break;\r\n      case '1M':\r\n        startDate.setMonth(endDate.getMonth() - 1);\r\n        break;\r\n      case '3M':\r\n        startDate.setMonth(endDate.getMonth() - 3);\r\n        break;\r\n      case '6M':\r\n        startDate.setMonth(endDate.getMonth() - 6);\r\n        break;\r\n      case '1Y':\r\n        startDate.setFullYear(endDate.getFullYear() - 1);\r\n        break;\r\n      default:\r\n        startDate.setMonth(endDate.getMonth() - 1);\r\n    }\r\n    \r\n    // Generar datos históricos simulados basados en el valor actual\r\n    const historicalData = generateHistoricalData(currentRate, startDate, endDate);\r\n    \r\n    // Asegurarse que el último elemento tenga la fecha y hora de hoy\r\n    if (historicalData.length > 0) {\r\n      const now = new Date();\r\n      historicalData[historicalData.length - 1].fecha = now.toISOString();\r\n    }\r\n    \r\n    return NextResponse.json(historicalData);\r\n    \r\n  } catch (error) {\r\n    console.error('Error fetching exchange rate:', error);\r\n    \r\n    // Generar datos de respaldo\r\n    const endDate = new Date();\r\n    const startDate = new Date();\r\n    startDate.setMonth(endDate.getMonth() - 1);\r\n    \r\n    const fallbackData = generateHistoricalData(3.75, startDate, endDate);\r\n    \r\n    return NextResponse.json(fallbackData, { status: 200 });\r\n  }\r\n}\r\n\r\n// Función auxiliar para generar datos históricos simulados con tendencia realista\r\nfunction generateHistoricalData(currentRate: number, startDate: Date, endDate: Date) {\r\n  const data = [];\r\n  const currentDateObj = new Date(startDate);\r\n  const totalDays = Math.floor((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\r\n  \r\n  // Generar una tendencia suave hacia el valor actual\r\n  const initialRate = currentRate * (0.97 + Math.random() * 0.06); // Variación inicial ±3%\r\n  \r\n  let dayIndex = 0;\r\n  while (currentDateObj <= endDate) {\r\n    // Interpolar entre el valor inicial y el actual con algo de ruido\r\n    const progress = dayIndex / totalDays;\r\n    const interpolatedRate = initialRate + (currentRate - initialRate) * progress;\r\n    \r\n    // Agregar variación diaria pequeña (±0.5%)\r\n    const dailyVariation = (Math.random() - 0.5) * 0.01 * interpolatedRate;\r\n    const rate = interpolatedRate + dailyVariation;\r\n    \r\n    // Para compra/venta, usar spread típico de 0.01-0.02 soles\r\n    const spread = 0.015;\r\n    const compra = rate - spread;\r\n    const venta = rate + spread;\r\n    \r\n    data.push({\r\n      compra: parseFloat(compra.toFixed(3)),\r\n      venta: parseFloat(venta.toFixed(3)),\r\n      fecha: currentDateObj.toISOString().split('T')[0]\r\n    });\r\n    \r\n    currentDateObj.setDate(currentDateObj.getDate() + 1);\r\n    dayIndex++;\r\n  }\r\n  \r\n  return data;\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}